<!DOCTYPE html>
<html>

<!-------        input,output是常规的websockets,  output1才是直播        -------->
<input id="input" type="text" />
<button onclick="send()">Send</button>
<pre id="output"></pre>

<video autoplay id="video" style="width:1600;height:900px"></video>
<canvas id="output1" style="display:none"></canvas>

<script src="/iris-ws.js"></script>
<script>
    var input = document.getElementById("input");
    var output = document.getElementById("output");
    var back = document.getElementById('output1'); //直播
    var backcontext = back.getContext('2d');
    var video = document.getElementById('video');

    //调用设备的摄像头,并将资源放入video标签
    navigator.mediaDevices.getUserMedia({
            video: true,
            audio: false
        })
        .then(function(stream) {
            video.srcObject = stream;
            video.play();
        })
        .catch(function(e) {
            console.log('Reeeejected!', e);
        })

    // Ws comes from the auto-served '/iris-ws.js'
    var scheme = document.location.protocol == "https:" ? "wss" : "ws";
    var port = document.location.port ? (":" + document.location.port) : "";
    var wsURL = scheme + "://" + document.location.hostname + port + "/echo";
    var socket = new Ws(wsURL)

    socket.OnConnect(function() {
        output.innerHTML += "Status: Connected\n";
    });

    socket.OnDisconnect(function() {
        output.innerHTML += "Status: Disconnected\n";
    });

    // read events from the server
    socket.On("chat", function(msg) {
        addMessage(msg);
    });

    function send() {
        addMessage("Me: " + input.value); // write ourselves
        socket.Emit("chat", input.value); // send chat event data to the websocket server
        input.value = ""; // clear the input
    }

    function addMessage(msg) {
        output.innerHTML += msg + "\n";
    }

    function draw() {
        try {
            backcontext.drawImage(video, 0, 0, back.width, back.height);
        } catch (e) {
            if (e.name == "NS_ERROR_NOT_AVAILABLE") {
                return setTimeout(draw, 100);
            } else {
                throw e;
            }
        }
        if (video.srcObject) {
            socket.Emit("png", back.toDataURL("image/jpeg", 0.5));
        }
        setTimeout(draw, 100);
    }
    draw();

</script>

</html>
